# Scripts used for analysisng single-cell sequencing data from heart was performed using R 4.0.0
# Data was first processed using 10x Genomics cellranger, cellranger-atac, or cellranger multi commands
# Plots and .rds files can be saved along the way using relevant scripts (not included in this workflow)
# Read README file to find sources of adapted scripts

################# scRNA-seq/snRNA-seq ##################

# Load relevant packages 
library(dplyr)
library(Seurat)
library(patchwork)
library(ggplot2)
 
# Read data (10x Genomics cellranger output)
Sample1.data <- Read10x(data.dir = "../Sample1/outs/filtered_feature_bc_matrix/")

# Check quality control (QC) metrics of data 
Sample1 <- CreateSeuratObject(counts = Sample1.data, project = "Sample1Analysis", min.cells = 3, min.features = 200)
Sample1[["percent.mt"]] <- PercentageFeatureSet(Sample1, pattern = "^MT-") 

# Visualise QC metrics
VlnPlot(Sample1, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3) # Violin plot
nCount_RNA_vs_percent.mt_plot <- FeatureScatter(Sample1, feature1 = "nCount_RNA", feature2 = "percent.mt") # Scatter plot (counts vs mt percent)
nCount_RNA_vs_nFeature_RNA_plot <- FeatureScatter(Sample1, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") # Scatter plot (counts vs gene feature)

# Data normalisation using NormalizeData
Sample1 <- NormalizeData(Sample1) 
## Alternatively data can be normalised using SCTransform

# Identify highly variable genes
Sample1 <- FindVariableFeatures(Sample1, selection.method = "vst", nfeatures = 2000)
top10 <- head(VariableFeatures(Sample1), 10)

# Visualise variable gene feature data 
VariableFeatures_plot <- VariableFeaturePlot(Sample1)
VariableFeaturesLabelled_plot <- LabelPoints(plot = VariableFeatures_plot, points = top10, repel = TRUE)

# Scale data
all.genes <- rownames(Sample1)
Sample1 <- ScaleData(Sample1, features = all.genes)

# Dimensionality reduction and PCA
Sample1 <- RunPCA(Sample1, features = VariableFeatures(object = Sample1))

# Assess dimensions  
VizDimLoadings(Sample1, dims = 1:2, reduction = "pca")
DimPlot_plot(Sample1, reduction = "pca")
DimHeatmap_plot(Sample1, dims = 1, cells = 74, balanced = TRUE)
DimHeatmap_plot(Sample1, dims = 1:15, cells = 74, balanced = TRUE)
Sample1 <- JackStraw(Sample1, num.replicate = 100)
Sample1 <- ScoreJackStraw(Sample1, dims = 1:20)
JackStrawPlot_plot(Sample1, dims = 1:15)
ElbowPlot_plot(Sample1)

# Visualise clusters  
Sample1 <- FindNeighbors(Sample1, dims = 1:20)
Sample1 <- FindClusters(Sample1, resolution = 0.5)
head(Idents(Sample1), 5)
Sample1 <- RunUMAP(Sample1, dims = 1:10)
DimPlot(Sample1, reduction = "umap")

################ scRNA-seq/snRNA-seq Sample integration ##################
# Uses FindIntegrationAnchors command 
# Read in multiple files to be combined 
Sample1 <- readRDS(“R:/File/Path/To/RDS/Sample1_Analysis.rds”)
Sample2 <- readRDS(“R:/File/Path/To/RDS/Sample2_Analysis.rds”)  
Sample3 <- readRDS(“R:/File/Path/To/RDS/Sample3_Analysis.rds”)  
Sample4 <- readRDS(“R:/File/Path/To/RDS/Sample4_Analysis.rds”) 

# If there are issues with loading multiple samples into R, use DietSeurat and ScaleData after each sample is loaded as shown below 
Sample1=DietSeurat(Sample1)
Sample1=ScaleData(Sample1)
Sample2=DietSeurat(Sample2)
Sample2=ScaleData(Sample2)
Sample3=DietSeurat(Sample3)
Sample3=ScaleData(Sample3)
Sample4=DietSeurat(Sample4)
Sample4=ScaleData(Sample4)

# Assign samples to individual groups 
Sample1$group1='001'
Sample2$group1='002'
Sample3$group1='003'
Sample4$group1='004'

# Assign samples to two groups 
Sample1$group2='Combined1'
Sample2$group2='Combined1'
Sample3$group2='Combined2'
Sample4$group2='Combined2'

# Combine samples together
anchors <- FindIntegrationAnchors(object.list = list(Sample1,Sample2,Sample3,Sample4), dims = 1:20)
combined_samples <- IntegrateData(anchorset = anchors, dims = 1:20)
DefaultAssay(combined_samples) <- "integrated"

# Re-run dimensionality reduction and clustering on integrated file 
combined_samples <- ScaleData(combined_samples, verbose = FALSE)
combined_samples <- RunPCA(combined_samples, npcs = 30, verbose = FALSE)
combined_samples <- RunUMAP(combined_samples, reduction = "pca", dims = 1:20)
combined_samples <- FindNeighbors(combined_samples, reduction = "pca", dims = 1:20)
combined_samples <- FindClusters(combined_samples, resolution = 0.5)
DimPlot(combined_samples, reduction = "umap", split.by = "group1") # Visualise PCA based on group allocation (group 1) 
DimPlot(combined_samples, reduction = "umap", split.by = "group2") # Visualise PCA based on group allocation (group 2) 

# Tests for differential expression
# Continue for however many clusters there are in dataset 
cluster0.markers <- FindMarkers(combined, ident.1 = 0, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster1.markers <- FindMarkers(combined, ident.1 = 1, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster2.markers <- FindMarkers(combined, ident.1 = 2, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster3.markers <- FindMarkers(combined, ident.1 = 3, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster4.markers <- FindMarkers(combined, ident.1 = 4, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster5.markers <- FindMarkers(combined, ident.1 = 5, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster6.markers <- FindMarkers(combined, ident.1 = 6, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster7.markers <- FindMarkers(combined, ident.1 = 7, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster8.markers <- FindMarkers(combined, ident.1 = 8, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster9.markers <- FindMarkers(combined, ident.1 = 9, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster10.markers <- FindMarkers(combined, ident.1 = 10, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)

# Create feature plots of gene expression 
## Murine cardiac cell type markers 
FeaturePlot(combined_samples, features = c("Tnnt2", "Ryr2", "Ttn")) # Cardiomyocyte markers 
FeaturePlot(combined_samples, features = c ("Pdgfra", "Vcan", "Mmp2")) # Fibroblast markers
FeaturePlot(combined_samples, features = c ("Pecam1", "Vwf", "Tie1")) # Endothelial cell markers
FeaturePlot(combined, features = c("Tagln", "Myh11", "Acta2")) # Smooth muscle cell markers
FeaturePlot(combined_samples, features = c("Ptprc")) # Lymphocyte
FeaturePlot(combined, features = c("Cd79a", "Cd79b", "Ly6d")) # B cell markers
FeaturePlot(combined, features = c("Cd3g", "Lat", "Skap1")) # B cell markers
## Human cardiac cell type markers 
FeaturePlot(combined, features = c("TNNT2", "RYR2", "TTN")) # cardiomyocytes
FeaturePlot(combined, features = c("PDGFRA", "VCAN", "MMP2")) # fibroblasts
FeaturePlot(combined, features = c("PECAM1", "VWF", "TIE1")) # endothelial cells
FeaturePlot(combined, features = c("CD3G", "LAT", "SKAP1")) # T cells
FeaturePlot(combined, features = c("CD79B", "LY6D", "CD79A")) # B cells
FeaturePlot(combined, features = c("PTPRC")) # Lymphocytes
FeaturePlot(combined, features = c("TAGLN", "MYH11", "ACTA2")) # SMCs
FeaturePlot(combined, features = c("CDKN1A", "CDKN2A", "TP53")) # senescent cells
## Human peripheral blood leucocyte markers
FeaturePlot(combined_samples, features = c("CD3E", "LCK", "TRAC")) # T cell markers 
FeaturePlot(combined_samples, features = c("IL7R", "CD4")) # CD4+ T cell markers 
FeaturePlot(combined_samples, features = c("CD8A", "CD8B", "CCL5")) # CD8+ T cell markers 
FeaturePlot(combined_samples, features = c("CD8na", "CCR7")) # Non-activated CD8+ T cell markers 
FeaturePlot(combined_samples, features = c("FOXP3", "CTLA4")) # Regulatory T cell markers  
FeaturePlot(combined_samples, features = c("TRDC")) # γδ T cell markers
FeaturePlot(combined_samples, features = c("FCGR3A", "CD14")) # Monocyte markers  
FeaturePlot(combined_samples, features = c("GNLY", "NKG7", "NCR1")) # NK cell markers
FeaturePlot(combined_samples, features = c("CD74", "CD79A", “IGH”) # B cell markers 
FeaturePlot(combined_samples, features = c("CD27", "IGHM") # Naïve B cell markers 
FeaturePlot(combined_samples, features = c("IGHG", "CD38", “TNFRSF17”) # Plasmablasts 
FeaturePlot(combined_samples, features = c("WDFY4", "XCR1", “BATF3”) # Myeloid dendritic cells 1
FeaturePlot(combined_samples, features = c("FCER1A”, "CD1C", “CLEC10A”) # Myeloid dendritic cells 2
FeaturePlot(combined_samples, features = c("S100A8", "S100A9") # Granulocyte markers 
FeaturePlot(combined_samples, features = c("CD14”)) # CD14+ Monocytes 
FeaturePlot(combined_samples, features = c("TCF4”, "TNFRSF21”) # Plasmacytoid dendritic cells
FeaturePlot(combined_samples, features = c("GNG11", "CLU")) # megakaryocytes

# Create dot plot of gene expression markers 
## Murine cardiac cell types
DotPlot(combined, features = c('Ttn','Tnnt2','Vcan','Pdgfra','Pecam1',‘Vwf’, ‘Ptprc’, ‘Cd3g’, ‘Tagln’, ‘Acta2’, ‘Sell’, ‘Myh11’), cols = c(“darkblue”, “firebrick”), dot.scale = 8) + RotatedAxis() 
## Human cardiac cell types
DotPlot(combined, features = c('TNNT2',’RYR2’,'TTN','PDGFRA','VCAN','PECAM1',‘VWF’,’TIE1’, ‘TAGLN’, ‘ACTA2’,‘MYH11’,‘PTPRC’), cols = c(“darkblue”, “firebrick”), dot.scale = 8) + RotatedAxis() 
## Human cardiac cell types 2
c('NPPA','MYL7','MYL4','MYH7','MYL2','FHL2','PLP1','NRXN1','NRXN3','CD8A','IL7R','CD40LG','CD14','C1QA','CD68','VWF','PECAM1','CDH5','GPAM','FASN','LEP','MSLN','WT1','BNC1','DCN','GSN','PDGFRA','RGS5','ABCC9','KCNJ8','MYH11','TAGLN','ACTA2'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - arterial endothelial cells 
DotPlot(combined, features = c('ST6GALNAC3','ALDH1A2','LDB2','PDE4D','NTN1','CGNL1','TMEM132C','EMCN','TMEM108','PECAM1','PLXNA4','PLCXD3','ADGRG6','CEMIP2','ENG','VWF','MYRIP','PKHD1L1','HMCN1','MMP16','TLE1','GMDS','CACNA2D1','NHSL2','GNA14','ITGA9','PLSCR4','RALYL','PCDH7','TMEM44'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - arterial endothelial cells 2
DotPlot(combined, features = c('ST6GAL1','EGFL7','SNTG2','AFAP1L1','LEPR','SELP','FREM2','NPR3','CD9','SESN3','TEK','PGM5','TENM1','PCDH17','KLHL4','SMAD6','CALCRL','TGM2','TIAM2','BMX','PODXL','ZNF804A','RASGEF1B','RALGAPA2','CSGALNACT1','PDE7B','TNFRSF10B','SH3RF1','LYPD6','GULP1'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - arterial endothelial cells 3 
DotPlot(combined, features = c('ERG','ANO2','ADGRL4','SIPA1L1','FLNB','FLT1','CA12','PLVAP','NT5E','F5','WNT9B','ATF7IP2','SMOC1','CRIM1','TSPAN5','NFATC2'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - capillary endothelial cells
DotPlot(combined, features = c('MCF2L','DLGAP2','VWF','CCDC85A','ABLIM3','EGFL7','FLT1','RAMP3','EMCN','CYYR1','EEPD1','ADGRL4','PTPRB','NUAK1','F8','MYRIP','SHANK3','LDB2','ERG','PECAM1','ITGA6','KANK3','SH2D3C','FLI1','PTPRM','MGLL','TEK','RPH3AL','ADAMTS9','RASIP1'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - capillary endothelial cells 2
DotPlot(combined, features = c('IFI27','IGFBP2','M10','ELK3','PPP1R16B','ARHGEF15','LRMDA','ADGRF5','PODXL','ENG','SEC14L1','RAPGEF1','KALRN','ADCY4','ARHGAP31','ARAP3','ITPKB','USHBP1','HECW2','PITPNC1','ZBTB46','ANO2','DOCK9','CDH5','DYSF','AFDN','GRIN2A','CMTM8','FGD5','GALNT18'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - capillary endothelial cells 3
DotPlot(combined, features = c('CXorf36','BACE2','PLEKHG1','MEOX2','CIITA','PDE2A','EPAS1','AFAP1L1','CD82','CARS','MAGI1','JAM2','EPHB4','DOCK6','STOX2','EML1','KIAA1671','MGAT5B','GFOD1','TSHZ2','LIMS2','FCN3','CADPS2','RALGAPA2','CCM2L','PALM','ATF7IP2','RFTN1','PKP4','ITGA1','CD74','SLC2A14'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - venous endothelial cells 
DotPlot(combined, features = c('ARL15','FLT1','CPAMD8','EEPD1','CYYR1','F8','MECOM','PODXL','EMCN','ADGRF5','ABLIM3','DOCK9','PTPRB','M10','PPP1R16B','MCF2L','CCDC85A','ADGRL4','EGFL7','IFI27','RAMP3','EPAS1','DLGAP2','PECAM1','PTPRM','GRIN2A','RAPGEF1','GFOD1','BTNL9','PIK3R3'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - venous endothelial cells 2
DotPlot(combined, features = c('ERG','SHANK3','EFNB2','CMTM8','HMCN1','TEK','EML1','PITPNC1','FCN3','MGAT5B','HECW2','SPOCK2','RUNDC3B','TSC22D1','RFTN1','ARHGAP31','MGLL','FGD5','USHBP1','LPCAT2','ADCY4','VWF','FMO2','ENG','IGFBP2','SEC14L1','KANK3','RPH3AL','ANXA3','AFDN'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - venous endothelial cells 3
DotPlot(combined, features = c('LDB2','TRMT9B','KIAA1671','RGCC','ARHGEF15','ITGA1','ANO2','ARAP3','CIITA','RASGRF2','RASIP1','TACC1','CXorf36','ITGA6','JAM2','NOTCH4','CD82','ID1','SULF2','CDH5','SUSD6','KIF25','ITPKB','CARS','SYNE2','NETO2','ZBTB46','EPB41L1','VEGFC','GPC5','AMD1','SLC6A6','CDK19'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - fibroblasts
DotPlot(combined, features = c('BICC1','C7','SVEP1','PID1','EYA2','FBLN5','FBLN1','DCN','ABI3BP','MALRD1','GLIS3','NPAS3','ABCA8','UST','ABCA9','LAMC1','ABCA10','AOX1','TBX20','CELF2','PDGFD','PDGFRA','ABCA6','FBN1','SCARA5','COL24A1','ANO4','COL3A1','PCSK6','KAZN'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - fibroblasts 2
DotPlot(combined, features = c('TGFBR3','ARHGAP21','UNC5C','CCDC102B','COL5A2','PTGIS','NOVA1','COL6A3','COL14A1','GFPT2','ANKS1B','GPC6','CP','CLDN11','STON2','CDON','GSN','CRISPLD2','CYP7B1','DDR2','WIF1','PRTFDC1','FOXP2','SRGAP1','COL1A2','VIT','ANTXR1','KIAA1755','ADAMTS2','EBF1'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - fibroblasts 3
DotPlot(combined, features = c('LTBP4','MAGI2','VCAN','BNC2','SEMA3E','PAMR1','CLMP','SPON1','XG','LPAR1','NAALADL2','IP6K2','EPHA3','FMO3','PTPN13','SETBP1','PCOLCE2'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - myofibroblasts
DotPlot(combined, features = c('TNC','ACTA2','MYH11','PCDH15','ACTG2','CNN1','FBLN1','NTRK3','TAGLN','WFDC1','ASPN','FAT3','CCDC3','MYLK','LMOD1','KCNMA1','STAMBPL1','LTBP2','AFF2','SLC22A3','ACTN1','CSRP1','TPM4','MCD','MYH10','DGKG','CPXM2','PAWR','SPEG','MRVI1'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - myofibroblasts 2
DotPlot(combined, features = c('TTLL7','ST6GALNAC3','SYNPO2','ITGA8','LPP','PRKG1','ARHGEF10L','RBPMS','CPED1','SMOC2','PALM2','ATF3','JPH2','DSTN','M1D','FAM129A','SLC44A5','PPP1R12B','PDLIM3','AKAP6','PPP1R12A','FILIP1','DES','STK38L','MICAL2','HTR7','DTNA','MBNL1','RCAN2','SORBS1'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - myofibroblasts 3
DotPlot(combined, features = c('COL4A1','DMD','ENAH','RGS6','KCNT2','FGF14','ACTN4','HIP1','C1QTNF1','SLC25A25','CRIM1','BICD1','RBFOX1','CREB5'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - smooth muscle cells
DotPlot(combined, features = c('MYH11','KCNAB1','SLC22A3','SLIT3','LMOD1','SLC38A11','ACTA2','KCNMA1','DGKG','CNNM2','CCDC3','SCN3A','CSMD1','DGKB','SDK1','MRVI1','CACNA1A','GRIP2','NOTCH3','PDE1A','HIP1','RGS6','WTIP','DOCK8','MCD','AKAP6','MYLK','ATP10A','SYNPO2','CACNA1C'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - smooth muscle cells 2
DotPlot(combined, features = c('TBL1X','FSTL5','NTRK3','SSH2','KALRN','RBPMS2','ZBTB7C','BCAM','CACNA1H','ITGA8','PRKG1','SORT1','L3MBTL4','GPC6','TBX2','RCAN2','PDE3A','UBA2','LGR6','NTRK2','SPECC1','SUSD5','MARK1','NXN','CARMIL1','PLCL1','M1D','PDGFRB','PRDM16','JPH2'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - smooth muscle cells 3
DotPlot(combined_QC2_SCT_doublet, features = c('NTF3','KIF13A','TAGLN','RBPMS','MAP3K20','RERGL','TPM1','HEYL','LBH','CLMN','DNAH11','LPP','ADCY5','MF','IL1RAPL1','CRIM1','PCDH9','HACL1','RNF150','SPARCL1','TPM4','KCND2','LAMA3','ADAMTS1','FILIP1L'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - pericytes
DotPlot(combined, features = c('EGFLAM','GUCY1A2','FRMD3','RGS5','SEMA5B','MDFIC2','CCBE1','PDGFRB','EPS8','M1B','IMPA2','ABCC9','PDE1C','NOTCH3','COL5A3','SLC12A2','ANO1','GPR176','GUCY1A1','DAAM2','NR2F2','RGS6','PACSIN2','ARHGAP10','PLCB4','GRK5','EBF2','LAMA3','CLMN','MRVI1'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - pericytes 2
DotPlot(combined, features = c('PMEPA1','NEURL1B','RGS6','VSTM4','GPC3','SPECC1','ARHGAP42','ADORA2B','IGFBP7','ARHGEF17','ITGA7','ZNF385D','ARHGAP6','ARHGAP15','C2CD2','GUCY1B1','STUM','LDLRAD3','PTEN','MEOX2','GALNT2','NXN','PLCE1','PDE5A','CYTH3','MYLK','SGCZ'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - cardiomyocytes
DotPlot(combined, features = c('TTN','LDB3','ANKRD1','FGF12','PACRG','MYBPC3','RBM20','DAPK2','CMYA5','MM2','RYR2','PALLD','MYH6','M18B','MYH7B','PKP2','MLIP','CORIN','TMEM182','FHOD3','CTNNA3','TECRL','ACTN2','KCNJ3','TNNI3','NEBL','NEXN','ASB18','NRAP','ZNF385B'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - cardiomyocytes 2
DotPlot(combined, features = c('SORBS2','DMD','CDH13','TRDN','MM1','TNNT2','LMOD2','MZ2','NDRG4','FHL2','CACNB2','OBSCN','PDZRN3','HS6ST3','MLF1','CLIC5','TBX5','TACC2','CASQ2','ERBB4','CDH4','CDH2','SGCG','GCNT2','AKAP6','MYPN','PAM','FBXO32','SPOCK3','ATG10'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - cardiomyocytes 3
DotPlot(combined, features = c('SCN5A','SLC8A1','ALPK2','MYH7','SORBS1','PRKAG2','TRIM55','PARM1','RRAD','PPARGC1A','WNK2','LMO7','TRIM54','RBFOX1','TRIM63','SRL','CKMT2','MYLK3','DNAH11','TXLNB','LARGE1','PDLIM5','FBXO40','NCEH1','B4GALNT3','MM3','RETREG1','AGBL4','CCSER1','SGCD'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - cardiomyocytes 4
DotPlot(combined, features = c('GCOM1','RBM24','MTUS2','DOK7','ABTB2','TENM2','PAMEYA4','CACNA1C','CSRP3','ATP2A2','FRAS1','NRG3','KCND3','RNF207','POPDC2','HCN1','PRUNE2','PPP2R3A','MITF','MAST2','TPM1','DTNA','PDK4','ADCY5','ACACB','GPCPD1','PPP1R3A','PPP1R14C','LRRFIP2','ACTC1'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - cardiomyocytes 5
DotPlot(combined, features = c('NCKAP5','PLIN5','TP63','SNTA1','MYL4','ZMAT4','RABGAP1L','PXDNL','PRDM16','ABLIM2','ART3','USP28','DOCK3','HOMER1','LGR6','REEP1','THSD4','SLC1A3','FAM129A','MCD','CPT1B','VEGFA','RAP1GAP2','ADRA1A','ABLIM1','ATP8A1','ALPK3','DUSP27','TNNT1','ROBO2','NPPA'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - hypertrophic cardiomyocytes
DotPlot(combined, features = c('SLC24A3','CNN3','MYH7','TRIM58','MYL2'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - epicardial cells
DotPlot(combined, features = c('ITLN1','EZR','PCDH15','SLC4A4','GPM6A','PKHD1L1','KCNT2','PRG4','WT1','VIPR2','FMN2','GRM7','ABCC4','ADGRD1','WWC1','C3','CFTR','SEMA3C','MYRF','GALNT18','MEDAG','MMP19','PTK2B','MSLNL','ALDH1A3','FADS1','PTPRQ','SLC26A4','KLF6','SYTL5'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - epicardial cells 2
DotPlot(combined, features = c('CDH3','HAS1','FGF9','STK35','ADAM12','BAIAP2L1','CDH1','BICDL1','TEX26','THBS2','ST8SIA2','WNT9A','SH3BP4','CDCP1','FAM198A','UPK3B','COL6A5','PTPRF','MSLN','TVP23A','SCN8A','EVA1C','ATF3','EFNA5','TSPAN5','FOS','ST6GAL1','GALNTL6','CACNA2D3','COBL','LMNA','FOXO3','DLGAP1','ATRNL1','COL6A6'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - epicardial cells 3
DotPlot(combined, features = c('SORCS2','BNC2','RBM47','PTGIS','PLEKHA7','PAPSS2','EFEMP1','FAM189A1','DSP','CDON','ITGB8','CPEB1','MAPK4','CDCP1','ARHGAP18','TIMP1','SLIT3','ARHGAP44','ROR2','SHROOM2','ROR1','SLC38A2','COBLL1','COLEC12','HPSE2','MCC','MN1','PDE10A','ZBTB7C','NUDT4'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - epicardial cells 4
DotPlot(combined, fFOXO3eatures = c('MAN1C1','PLXNA2','CHST11','ALDH1A2','IGFBP5','EXTL3','RBFOX1','ACSL4','PKD2','LAMA3','NEO1','PLXNA4','RAB11FIP3','FOSB','MICAL2','INSR','KIRREL3','PDE7B','SULF1','ANXA1','ANTXR1','CEP85L','THSD4','SLC7A8','ENPP1','SLC22A15','LRRFIP1','KSR1','DAPK1','HTT'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - cardiac conduction cells
DotPlot(combined, features = c('NRXN1','XKR4','GRIK2','CDH19','SORCS1','IL1RAPL2','FRMD4A','CNTN4','SLC35F1','SYT1','ZNF536','PPP2R2B','ST6GALNAC5','CADM2','FRMD5','NLGN4X','COL28A1','ADGRL3','CHL1','TSPAN11','SAMHD1','CADM1','IL1RAPL1','KLHL29','ADARB2','KCNMB4','FIGN','PRKCA','SLIT2','NDST3'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - cardiac conduction cells 2
DotPlot(combined, features = c('SRCIN1','DGKG','GALNT17','ANK3','NCAM1','NEGR1','ERBB3','TENM3','PTPRZ1','NLGN1','LRFN5','ARAP2','GPM6B','LRRTM4','ATP10B','NRXN3','TMEM178B','MACROD2','LGI4','IQGAP2','SOX6','SEMA3B','STARD13','NRN1','ENOX1','ALCAM','PAPPA','POLR2F','KCNH8','BCL2'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - cardiac conduction cells 3
DotPlot(combined, features = c('SHISA6','CSMD2','NTM','ITGB4','ARHGEF26','VWA3B','COBL','KCNQ5','ADAM23','ADGRB3','SGIP1','ADAMTS12','GPM6B','CPPED1','EFR3B','IGSF11','NTNG1','MDGA2','SOX10','KIAA1217','SCN7A','MEGF9','MPP7','DNAJC6','HSPA12A','WDR72','DOCK5','KHDRBS3','STK32A','GFRA1'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - cardiac conduction cells 4
DotPlot(combined, features = c('GRIK3','TRIM9','ADK','ST3GAL5','SLC5A7','SNCA','TGFBR2','MEGF10','SH3PXD2A','HUNK','PTPRJ','FAM135B','EDIL3','SIPA1L2','NCAM2','SCN9A','XYLT1','BCHE','ADAMTS19','CAB39L','PYGL','SORCS2','AFAP1L2','GRAMD2B','CNTN1','CHST9','VGLL3'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - Schwann cells
DotPlot(combined, features = c('PEX5L','MPZ','AK5','PRX','FA2H','GRIA2','BCAS1','AATK','DRP2','PLLP','PGBD5','TNFRSF25','KIF19','SEC14L5','SPTBN5','FRMD1','KCNK12','TSPAN15','MAG','NCMAP','KANK4','CDH7','GRIA1','PLXNB3','FMN2','MAL','ABCC8','FAM198A','SHC4','NKAIN2','SORCS1','SDK1','PRIMA1','GLDN','PTPRU','GAS2L3','RELN','S100B','PLP1','LRRTM4','MBP','SYT14','SNCA','SH3TC2','EMID1','GRIN2B','NFASC','PLEKHB1','ZNF536','FAM81A','LPIN1','PLEKHG7','NRCAM','WDR86','POLR2F','CDH1','TMEM132B','CLCN2','FUT8','ERBB3','LGI4','SGK1','SYT1','PLEKHA7','CDKL1','ADARB2','GALNT17','LONRF2','IL16','PMP22','HCN1','EFR3B','SECISBP2L','MVB12B','SH3GLB2','ITGB4','GPM6A','PRKCA','SGCD','ARHGAP39','SCD5','SEMA3B','NDRG1','SOX10','TRABD2B','KLHL3','MEGF9','NEK1','TESK2','GPT2','ZNF608','WNK2'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - Schwann cells 2
DotPlot(combined, features = c('RNF220','MLIP','TMEM120B','LDLRAD3','PPM1L','PPP1R9A','PLEKHG3','MPP6','OTUD7B','PLEKHG2','CNKSR2','SORBS1','DMD','CUX1','PACS2','OAF','TNS3','PLEKHG5','CDH4','RHOBTB3','RAP1GDS1','KIF21A','KAZN','CTNNA3','TMEM117','SPIRE1','AGAP1','FLNB','RPS6KA2','TJP1','GATM','LIMCH1','FRMD8','SORT1','SERINC5','TRPM3','SYT9','SH3PXD2A','ATP1A4','SLC44A1','FSTL5','B4GALNT3','FMNL3','SH3D19','FAM13B'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - adipocytes
DotPlot(combined, features = c('ADIPOQ','NWD2','LGALS12','PLIN1','GPD1','CIDEA','KLB','TRARG1','PFKFB1','SLC7A10','ACVR1C','APOL6','CRACR2B','PTPRF','GABRE','KCNK1','FABP4','LIPE','SMOC1','GPAM','LVRN','PLIN4','ADH1B','ESR2','CNIH3','ACSL1','WDR86','GALNTL6','PSMA1','GNAI1','AOX2','LPL','ANGPTL4','ARHGAP20','CD1D','GPT2','PTGER3','ALDH1L1','IDH1','PPARG','PDE3B','CSAD','SLC11A1','LPIN1','LPIN2','PLA2G16','CCDC69','PGD','AQP7','SLC22A3','ACACB','SCARB1','ANXA1','TMEM132C','SIK2','LDLRAD3','MPP6','GHR','ACER2','SCUBE2','LURAP1L','SYNE3','ACER3'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - adipocytes 2
DotPlot(combined, features = c('CPE','ENPP2','PRKAG2','ECM2','CLMP','ELL2','SLC4A4','LMNTD1','PAPSS1','NET1','HACD2','ADAMTS12','RETSAT','TBC1D16','EFNA5','CCDC3','ADAM18','CECR2','BCL2','DDHD1','METAP1','PALM2','TXLNG','TMEM131L','PCCA','PTPRS','MAST4','PNPLA7','NRP1','SORT1','ANP32A','TLN2','IGF1','IRS2','ALDH1A1','GPHN','EBF1','PTEN','PFKFB3','FGF1','ITSN1','FAM241A','ZFAND5','ANO6','LIMA1','CNTFR','TRHDE','OSBPL11','JAG1','SYNDIG1','TPCN1','SOX5','SH3KBP1','ECHDC1','RAD51B','TCF7L2','TENM3','STARD13','SPOCK3','HLCS','NTM','SEMA3E','TNFAIP8','CLSTN2','LRIG1','DIXDC1','ANKS1B','COL4A1','ACSS3','TCF7L1','SKI','ACSS2','RAB30','RNF217','FAM13A','SULF1'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - M1 macrophages
DotPlot(combined, features = c('CPVL','WDFY4','AOAH','MNDA','CD86','SYK','KCNK13','POU2F2','CSF1R','PLCB2','PILRA','HCK','FLT3','CYBB','P2RX1','FGD2','CLEC7A','ADA2','DOCK2','PIK3AP1','CD83','IKZF1','TNFRSF11A','MS4A7','CYTH4','RBM47','ITGAX','PTPRC','HLA-DPB1','NLRP3','INPP5D','PIK3R5','COTL1','LCP1','LCP2','TBXAS1','CD4','NCKAP1L','LYN','VAV1','CD74','LCP2','HLA-DRA','RAB31','KYNU','SEMA4A','DOCK10','ITGAM','ITGA4','LMO2','NRROS','ATP8B4','HTR7','BLNK','PRKCB','FYB1','MAN2B1','HLA-DPA1','PREX1','CTSS','CIITA','MBP'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - M1 macrophages 2
DotPlot(combined, features = c('IPCEF1','RUNX1','MRC1','PLXNC1','SMIM35','SRGN','PTK2B','SAMSN1','MTSS1','ADAP2','CD163','ST8SIA4','MSR1','PTPRJ','APBB1IP','RNF149','VAV3','SIRPA','ARHGAP15','PRCP','ELMO1','XYLT1','SMAP2','SH2B3','RNF144B','TBC1D9','TUT7','SLC6A6','UBASH3B','TSPAN33','CMIP','TNFRSF1B','REL','CD44','ETV6','ANKRD44','SKAP2','STK17B','ALCAM','ARHGAP22','ARRB1','DAPK1','RASA3','EMILIN2','CPM','M9B','PSAP','TBC1D22A','IFNGR2','RTN1','TBC1D14','CAMK1D','CCDC88A','PSTPIP2','SLC43A2','ATP2B1','SLC9A9','FAM49A','INPP4A','ZEB2','PDE3B','FAM107B','RBPJ','HDAC9','KIF16B','SULF2','RAP1GAP2','DENND4A','AFF3'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - M2 macrophages
DotPlot(combined, features = c('CPM','STAB1','F13A1','CD163','MRC1','DAB2','MTSS1','RBM47','PDGFC','CD163L1','MSR1','LGMN','SLC16A10','MS4A7','HPGDS','FRMD4B','CSF1R','MAMDC2','TBXAS1','MCTP1','SLC9A9','PTGER3','PDE7B','THSD7A','SIGLEC1','IQGAP2','RGL1','CTSC','SLCO2B1','FMN1','SLC7A8','LYVE1','CD4','NRROS','RAB31','MERTK','HTR7','VAV3','COLEC12','ADAP2','TUT7','M5A','ATRNL1','ITSN1','TNS3','PSTPIP2','ELMO1','RBPJ','FYB1','ARHGAP22','DOCK2','SDC2','CCDC141','SNX24','SYK','TBC1D14'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - M2 macrophages 2
DotPlot(combined, features = c('PIK3AP1','KYNU','AP1B1','RTN1','TNFRSF21','RUNX1','DMXL2','SMIM35','BCAT1','FCGR2A','SNX29','TRPS1','IGF1','NRP2','ITGAM','WDFY4','SLC40A1','KCNMA1','CD209','LRMDA','LRP11','DERA','CMKLR1','CD83','PLXNC1','CMIP','SKAP2','ARRB1','SRGN','GDPD1','AP2A2','C1QA','SPRED1','ITGA9','VAV1','ARHGAP18','ZEB2','SNX9','ZSWIM6','ARHGAP24','EMB','MS4A6A','INPP5D','CYTH4','EPS15','CD86','CYBB','CD55','SMAP2','KMO','FNBP1','CAMK1D','NCKAP1L','PRCP','CD44'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - M2 macrophages 3
DotPlot(combined, features = c('OSBPL11','RASGEF1B','FKBP5','CLCN5','SNX2','UBASH3B','DIP2B','BCAR3','TLE4','CD200R1','TEC','DNM1','GAS7','VSIG4','PEPD','ABCC3','TBC1D9','DPYD','ABCC1','PLEKHG5','SP140','MVB12B','ATG7','NKD2','GRB2','MAN1C1','CTSS','TFEC','RNF149','FLI1','DOCK8','TGFBI','LCP','MBP','BMP2K','AOAH','ETV6','ETS2','BLNK','CD74','ZFP36L1','EDA','GPC5','ASTN2'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - T cells
DotPlot(combined, features = c('RIPOR2','SKAP1','IKZF1','PTPRC','BCL11B','CARD11','BTBD11','CD247','THEMIS','CAMK4','RUNX1','ITK','DOCK2','GRAP2','SCML4','PREX1','FYB1','CLEC2D','CHST11','TOX','PRKCB','ANKRD44','ITGA4','MBP','PRKCQ','LCP2','PTPN22','TRAC','CD96','RASGRP1','DOCK8','TGFB1','ZC3HAV1','TNIK','CD6','EVL','CCDC88C','AKNA','STAT4','RASSF1','ARHGAP15','EML4','SYTL3','SORL1','ZAP70','CD84','STK10','STK17A','FNBP1','SH3KBP1','TTC39C','SLA2','ADGRE5','ATP10A','FGD3','VAV1','APBB1IP','ST8SIA4','KCNAB2','TRAF3IP3','RGS9','ST8SIA1','CAMK1D','GIMAP7','PSTPIP1','ANKRD11','NRROS','RAB27A','PIP4K2A','EFCC1','PDE3B','GLCCI1','TESC','ERN1'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - T cells 2
DotPlot(combined, features = c('IKZF3','DOCK10','NEDD9','GNG2','ATP2A3','CYFIP2','ARHGAP25','BIN2','LAT','PITPNC1','LCP1','STK17B','INPP4B','NLRC5','DIAPH1','SEMA4D','ARHGEF1','ARHGAP45','CD244','SLA','UBASH3A','XYLT1','PARP8','PYHIN1','SIRPG','IQGAP2','TBC1D10C','UBASH3B','TNFAIP8','JAKMIP2','SIGIRR','WIPF1','PAG1','FAM107B','RASAL3','INPP5D','CLEC12A','CCM2','ITGB2','PIK3R5','ETS1','SLFN12L','SAMD3','PIK3CD','PTK2B','CORO1A','TMC8','INPP4A','CD226','STK4','PPP2R2B','ARHGAP4','CASP8','CD44','FMNL1','NBEAL2','NFATC2','SASH3','COTL1','M1G','NUP210','KIAA1551','PRKD2','PACS1','ADAM23','CYTH1','FAM69A','DNAJC1','UBAC2','SFMBT2','GRAMD1B','RAP1GAP2'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - B cells
DotPlot(combined, features = c('FCRL1','CD22','FCMR','FCRL5','MS4A1','BTLA','BLK','PAX5','SEL1L3','TMEM154','POU2F2','WDFY4','CD79B','BANK1','DAPP1','CYB561A3','SYK','C16orf74','CD37','IL21R','LAPTM5','CD53','DOCK2','IKZF3','EAF2','IKZF1','PIK3AP1','PLCG2','PRKCB','CARD11','SLC15A2','RIPOR2','AFF3','NUP210','ATP2A3','TMEM156','HCK','ANKRD33B','INPP5D','PTPRC','CD38','ARHGAP45','NCF1','HIP1R','FGD2','FAM81A','DOCK8','CIITA','RUBCNL','PRAG1','LYN','SLC11A1','IL7','CD83','PTPN22','CCDC88C','ITGAX','HVCN1','XYLT1','CD74','ARHGAP15','CYFIP2','STK17B','IQSEC1','SCIMP','SP140','BCL11A','PIK3R5','TMEM131L','MTSS1','TTC7A','TNFAIP8'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human cardiac cell types - B cells 2
DotPlot(combined, features = c('PLPP5','RALGPS2','FGD3','SMC6','ANKRD44','NRROS','MAST3','SMAP2','LIMD2','ARHGAP24','GEN1','CTSS','VAV3','KCNQ5','COTL1','ST6GAL1','LPCAT1','VAV2','DOCK10','CBFA2T3','ITGA','GPR155','BLNK','RAPGEF1','RASA3PIK3R5','MEF2C','ARHGEF1','TOX2','NLRC5','ADAM19','CPPED1','EIF2AK3','SP110','OSBPL10','RCSD1','CMIP','RPS6KA5','FAM53B','SNX29','DGKD','CD47','EZR','RUNX1','KYNU','SCML4','GRB2','DENND5B','IQGAP2','TRAF3','FCHSD2','NCOA3','TBC1D9','KDM4B','SKAP2','FAM69A','EIF4G3','UVRAG','ERGIC1','SWAP70','CEMIP2','DTNBP1','CCDC50','IL4R','DENND4A','PLXNC1','BACH2','MAP3K1','PIP5K1B','FAM117B','SOX5','SPAG16'), cols = c("darkblue", "firebrick"), dot.scale = 8) + RotatedAxis()
## Human circulating leucocytes 
DotPlot(combined, features = c('CD3E','TRAC','IL7R','CD8B','CCR7','FOXP3','TRDC','GNLY','FCGR3A’, ‘SELL’, ‘CD79A’. ‘IGHD’, ‘CD27’, ‘CD36’, ‘LYZ’, ‘WDFY4’, ‘FCER1A’, ‘S100A8’, ‘CD14’, ‘TCF4’, ‘GNG11’), cols = c("blue", "red"), dot.scale = 8) + RotatedAxis() 

# Create volcano plot of variable genes between allocated groups
fcdata <- FindMarkers(combined, ident.1 = "Combined1", ident.2 = "Combined2", verbose = FALSE, group.by = 'group2')
EnhancedVolcano: :EnhancedVolcano(fcdata, lab=rownames(fcdata, x=’avg_log2FC’,y= ‘p_val_adj’, subtitle='',
legendLabSize=1, legendIconSize=0.5, titleLabSize= 10, title='Combined1 vs Combined2,
legendPosition='below',pCutoff=0.05,FCcutoff = 0.25,col=c("grey30","cornsilk4", "royalblue", "red2"))

################ Processing multiplexed snRNA-seq data ##################
# Pipelines used from cellranger multi and CITE-seq
## cellranger multi 
cd /filepath/to/output/file/directory
export PATH=/$PWD/cellranger-6.1.1:$PATH
cellranger multi --id=sampleID_mux \
--csv=multi-config.csv \
--localmem=128 \
--localcores=8

reference,/filepath/to/reference/refdata-gex-GRCh38-2020-A/
cmo-set,/file/path/to/cmo/file/cmoset1.csv
expect-cells,10000
include-introns,true

# Find FASTQ library locations
Sample001a-AK3737_HK53LDSX2,/file/path/to/fastq/directory/,Multiplexing Capture
Sample001a-AK3737_HLTGWDSX2,/file/path/to/fastq/directory/,Multiplexing Capture
Sample001b-AK3738_HK53LDSX2,/file/path/to/fastq/directory/,Multiplexing Capture
Sample001b-AK3738_HLTGWDSX2,/file/path/to/fastq/directory/,Multiplexing Capture
Sample001c-AK3739_HK53LDSX2,/file/path/to/fastq/directory/,Gene Expression
Sample001c-AK3739_HLTGWDSX2,/file/path/to/fastq/directory/,Gene Expression
Sample001d-AK3740_HK53LDSX2,/file/path/to/fastq/directory/,Gene Expression
Sample001d-AK3740_HLTGWDSX2,/ file/path/to/fastq/directory/,Gene Expression

# Input patient sample IDs
sample_id,cmo_ids
PtSample001,TotalSeq_A0451_anti_nuclearporecomplexproteinshashtag4
PtSample002,TotalSeq_A0451_anti_nuclearporecomplexproteinshashtag5
PtSample003,TotalSeq_A0451_anti_nuclearporecomplexproteinshashtag6

# Input unique barcode for multiplexing
id,name,read,pattern,sequence,feature_type
TotalSeq_A0451_anti_nuclearporecomplexproteinshashtag4,\
PtSample001,R2,5P(BC),TGGTGTCATTCTTGA,Multiplexing Capture
TotalSeq_A0451_anti_nuclearporecomplexproteinshashtag5, \
PtSample002,R2,5P(BC),ATGATGAACAGCCAG,Multiplexing Capture
TotalSeq_A0451_anti_nuclearporecomplexproteinshashtag6, \
PtSample003,R2,5P(BC),CTCGAACGCTTATCG,Multiplexing Capture

## CITE-seq
CITE-seq-Count --threads 12 -R1 cat001_R1.fastq.gz -R2 cat001_R2.fastq.gz -t antibtags.csv -wl 3M-february-2018.txt -cbf 1 -cbl 16 -umif 17 -umil 28 --sliding-window -cells 10000 -o filename 

################ snATAC-seq data ##################


# Load relevant packages  
library(Signac)
library(Seurat)
library(GenomeInfoDb)
library(EnsDb.Mmusculus.v79)
library(patchwork)
library(ggplot2)
set.seed(1234)


# Pre-processing workflow
## Read data
counts <- Read10X_h5(filename = "filtered_peak_bc_matrix.h5")
metadata <- read.csv(
  file = "singlecell.csv",
  header = TRUE,
  row.names = 1
)  

chrom_assay <- CreateChromatinAssay(
  counts = countsA005,
  sep = c(":", "-"),
  genome = 'mm10',
  fragments = 'fragments.tsv.gz',
  min.cells = 1,
  min.features = 200
)

Sample1 <- CreateSeuratObject(
  counts = chrom_assay,
  assay = "peaks",
  meta.data = metadata
)

Sample1
Sample1[['peaks']]
granges(Sample1)

# Extract gene annotations from EnsDb
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Mmusculus.v79)
seqlevelsStyle(annotations) <- 'UCSC' # Change to UCSC style

# Add the gene information to the object 
genome(annotations) <- "mm10"
Annotation(Sample1) <- annotations

# Computing QC metrics
Sample1 <- NucleosomeSignal(object = Sample1) # Compute nucleosome signal score per cell
Sample1 <- TSSEnrichment(object = Sample1, fast = FALSE) # Compute TSS enrichment score per cell

# Add blacklist ratio and fraction of reads in peaks 
Sample1$pct_reads_in_peaks <- Sample1$peak_region_fragments / Sample1$passed_filters * 100
Sample1$blacklist_ratio <- Sample1$blacklist_region_fragments / Sample1$peak_region_fragments
Sample1$high.tss <- ifelse(Sample1$TSS.enrichment > 2, 'High', 'Low')
TSSPlot(Sample1, group.by = 'high.tss') + NoLegend() # Visualise TSS enrichment scores 
Sample1$nucleosome_group <- ifelse(Sample1$nucleosome_signal > 4, 'NS > 4', 'NS < 4')
FragmentHistogram(object = Sample1, group.by = 'nucleosome_group') # Visualise nucleosomal strength score

# Visualise QC metrics
VlnPlot(
  object = Sample1,
  features = c('pct_reads_in_peaks', 'peak_region_fragments',
               'TSS.enrichment', 'blacklist_ratio', 'nucleosome_signal'),
  pt.size = 0.1,
  ncol = 5
)

# Remove outliers according to QC metrics
Sample1 <- subset(
  x = Sample1,
  subset = peak_region_fragments > 500 &
    peak_region_fragments < 20000 &
    pct_reads_in_peaks > 15 &
    blacklist_ratio < 0.05 &
    nucleosome_signal < 4 &
    TSS.enrichment > 2
)

# Normalisation and linear dimensional reduction 
Sample1 <- RunTFIDF(Sample1)
Sample1 <- FindTopFeatures(Sample1, min.cutoff = 'q0')
Sample1 <- RunSVD(Sample1)
DepthCor(Sample1)

# Non-linear dimension reduction and clustering 
Sample1 <- RunUMAP(object = Sample1, reduction = 'lsi', dims = 2:30)
Sample1 <- FindNeighbors(object = Sample1, reduction = 'lsi', dims = 2:30)
Sample1 <- FindClusters(object = Sample1, verbose = FALSE, algorithm = 3)
DimPlot(object = Sample1, label = TRUE) + NoLegend() # Visualise UMAP plot
# Creating a gene activity matrix
Sample1[[‘RNA’]]<- CreateAssayObject(counts = gene.activites)
Sample1 <- NormalizeData(
 	object = Sample1,
	assay = ‘RNA’,
	normalisation.method = ‘LogNormalize’
	scale.factor = median(Sample1$nCount_RNA)
DefaultAssay(Sample1) <- ‘RNA’
FeaturePlot(
object = Sample1,
features = c(‘Insert’, ‘List’, ‘Here’),
pt.size = 0.1,
max.cutoff = ‘q95’
ncol=3
)

